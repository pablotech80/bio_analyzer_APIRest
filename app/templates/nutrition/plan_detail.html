{% extends "base.html" %}

{% block title %}Plan Nutricional - {{ analysis.created_at.strftime('%d/%m/%Y') }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-xl-10 col-lg-11 mx-auto">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-egg-fried me-2" style="color: #E67E22;"></i>
                        Plan Nutricional
                    </h1>
                    <p class="text-muted mb-0">
                        Generado el {{ analysis.created_at.strftime('%d/%m/%Y a las %H:%M') }}
                        <span class="badge bg-success ms-2">
                            <i class="bi bi-robot me-1"></i>FitMaster AI
                        </span>
                    </p>
                </div>
                <div>
                    <a class="btn btn-outline-secondary rounded-pill me-2" href="{{ url_for('nutrition.my_plans') }}">
                        <i class="bi bi-arrow-left me-1"></i>Volver
                    </a>
                </div>
            </div>

            <!-- Plan Nutricional Card -->
            <div class="card shadow-sm mb-4" style="border: 2px solid #27AE60;">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #27AE60 0%, #229954 100%);">
                    <h2 class="h5 mb-0">
                        <i class="bi bi-clipboard-check me-2"></i>Tu Plan Nutricional Personalizado
                    </h2>
                </div>
                <div class="card-body">
                    {% set nutrition = plan %}

                    <!-- Objetivo -->
                    {% if nutrition.goal %}
                    <div class="alert alert-success mb-4">
                        <h5 class="alert-heading">
                            <i class="bi bi-bullseye me-2"></i>Objetivo Nutricional
                        </h5>
                        <p class="mb-0 lead">{{ nutrition.goal }}</p>
                    </div>
                    {% endif %}

                    <!-- Calorías Diarias -->
                    {% if nutrition.daily_calories %}
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card bg-light border-0">
                                <div class="card-body text-center py-4">
                                    <h6 class="text-muted mb-2">CALORÍAS DIARIAS RECOMENDADAS</h6>
                                    <h2 class="display-4 mb-0" style="color: #E67E22; font-weight: 700;">
                                        {{ nutrition.daily_calories }} <small class="text-muted fs-5">kcal</small>
                                    </h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Distribución de Macronutrientes -->
                    {% if nutrition.macros %}
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="bi bi-pie-chart me-2" style="color: #E67E22;"></i>
                            Distribución de Macronutrientes
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <i class="bi bi-egg-fill" style="font-size: 2rem; color: #27AE60;"></i>
                                        <h3 class="mt-3 mb-0" style="color: #27AE60;">{{ nutrition.macros.protein or 0 }}g</h3>
                                        <p class="text-muted mb-0">Proteínas</p>
                                        <small class="text-muted">
                                            {% if nutrition.daily_calories %}
                                            {{ ((nutrition.macros.protein or 0) * 4 / nutrition.daily_calories * 100) | round(1) }}%
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-warning">
                                    <div class="card-body text-center">
                                        <i class="bi bi-basket-fill" style="font-size: 2rem; color: #F39C12;"></i>
                                        <h3 class="mt-3 mb-0" style="color: #F39C12;">{{ nutrition.macros.carbs or 0 }}g</h3>
                                        <p class="text-muted mb-0">Carbohidratos</p>
                                        <small class="text-muted">
                                            {% if nutrition.daily_calories %}
                                            {{ ((nutrition.macros.carbs or 0) * 4 / nutrition.daily_calories * 100) | round(1) }}%
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-danger">
                                    <div class="card-body text-center">
                                        <i class="bi bi-droplet-fill" style="font-size: 2rem; color: #E74C3C;"></i>
                                        <h3 class="mt-3 mb-0" style="color: #E74C3C;">{{ nutrition.macros.fat or nutrition.macros.fats or 0 }}g</h3>
                                        <p class="text-muted mb-0">Grasas</p>
                                        <small class="text-muted">
                                            {% if nutrition.daily_calories %}
                                            {{ (((nutrition.macros.fat or nutrition.macros.fats or 0)) * 9 / nutrition.daily_calories * 100) | round(1) }}%
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Ejemplo de Comidas -->
                    {% if nutrition.meals %}
                    <div class="mb-0">
                        <h5 class="mb-3">
                            <i class="bi bi-list-ul me-2" style="color: #E67E22;"></i>
                            Ejemplo de Comidas Diarias
                        </h5>
                        <div class="accordion" id="mealsAccordion">
                            {% for meal in nutrition.meals %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ loop.index }}">
                                    <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" 
                                            type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#collapse{{ loop.index }}" 
                                            aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" 
                                            aria-controls="collapse{{ loop.index }}">
                                        <i class="bi bi-clock me-2" style="color: #E67E22;"></i>
                                        <strong>{{ meal.name }}</strong>
                                    </button>
                                </h2>
                                <div id="collapse{{ loop.index }}" 
                                     class="accordion-collapse collapse {% if loop.first %}show{% endif %}" 
                                     aria-labelledby="heading{{ loop.index }}" 
                                     data-bs-parent="#mealsAccordion">
                                    <div class="accordion-body">
                                        <p class="mb-0">{{ meal.description }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    Este plan es una guía general. Consulta con un nutricionista para un plan más específico.
                </div>
            </div>

            <!-- Datos del Análisis Relacionado -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-person-badge me-2"></i>Datos del Análisis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6 col-md-3">
                            <small class="text-muted d-block">Peso</small>
                            <strong>{{ '%.1f'|format(analysis.weight) }} kg</strong>
                        </div>
                        <div class="col-6 col-md-3">
                            <small class="text-muted d-block">Altura</small>
                            <strong>{{ '%.1f'|format(analysis.height) }} cm</strong>
                        </div>
                        <div class="col-6 col-md-3">
                            <small class="text-muted d-block">IMC</small>
                            <strong>{{ '%.2f'|format(analysis.bmi) }}</strong>
                        </div>
                        <div class="col-6 col-md-3">
                            <small class="text-muted d-block">% Grasa</small>
                            <strong>{{ '%.1f'|format(analysis.body_fat_percentage) }}%</strong>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('bioanalyze.result', analysis_id=analysis.id) }}" 
                           class="btn btn-sm btn-outline-primary rounded-pill">
                            <i class="bi bi-eye me-1"></i>Ver Análisis Completo
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
